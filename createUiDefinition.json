{
    "handler": "Microsoft.Compute.MultiVm",
    "version": "0.0.1-preview",
    "parameters": {
        "basics": [
            {
                "name": "dnsNameForPublicIP",
                "type": "Microsoft.Common.TextBox",
                "label": "F5 WAF Cluster Name",
                "defaultValue": "f5wafcl01",
                "constraints": {
                    "required": true,
                    "regex": "^[a-z0-9A-Z]{1,10}$",
                    "validationMessage": "Only letters and numbers are allowed, and the value must be 1-10 characters long."
                }
            }
        ],
        "steps": [
            {
                "name": "infrastructureConfig",
                "label": "Infrastructure Settings",
                "subLabel": {
                    "preValidation": "Configure Infrastructure Settings for the F5 WAF Cluster",
                    "postValidation": "Done"
                },
                "bladeTitle": "Infrastructure Settings",
              "elements": [
                {
                  "name": "adminUsername",
                  "type": "Microsoft.Compute.UserNameTextBox",
                  "label": "Username",
                  "toolTip": "Admin username for the virtual machines. Same Credientials is to SSH to the box.",
                  "osPlatform": "Linux"
                },
                {
                  "name": "SSHCredntials",
                  "type": "Microsoft.Compute.CredentialsCombo",
                  "label": {
                    "authenticationType": "Authentication type",
                    "password": "Password",
                    "confirmPassword": "Confirm password",
                    "sshPublicKey": "SSH public key"
                  },
                  "toolTip": {
                    "authenticationType": "",
                    "password": "",
                    "sshPublicKey": ""
                  },
                  "constraints": {
                    "required": true
                  },
                  "options": {
                    "hideConfirmation": false
                  },
                  "osPlatform": "Linux"
                },
                {
                  "name": "numberOFWAFs",
                  "type": "Microsoft.Common.DropDown",
                  "label": "Numbe of WAFs",
                  "defaultValue": "2",
                  "toolTip": "The number of individual F5 WAFs (nodes) to provision for this cluster.",
                  "constraints": {
                    "allowedValues": [
                      {
                        "label": "1",
                        "value": 1
                      },
                      {
                        "label": "2",
                        "value": 2
                      },
                      {
                        "label": "3",
                        "value": 3
                      },
                      {
                        "label": "4",
                        "value": 4
                      },
                      {
                        "label": "5",
                        "value": 5
                      },
                      {
                        "label": "6",
                        "value": 6
                      },
                      {
                        "label": "7",
                        "value": 7
                      },
                      {
                        "label": "8",
                        "value": 8
                      }
                    ]
                  }
                },
                {
                  "name": "clusterVmSize",
                  "type": "Microsoft.Compute.SizeSelector",
                  "label": "Virtual machine size",
                  "toolTip": "The size of virtual machine to provision for each cluster node.",
                  "recommendedSizes": [
                    "Standard_D1",
                    "Standard_D2",
                    "Standard_D3",
                    "Standard_D4"
                  ],
                  "constraints": {
                    "allowedSizes": [
                      "Standard_D1",
                      "Standard_D2",
                      "Standard_D3",
                      "Standard_D4"
                    ]
                  },
                  "osPlatform": "Linux",
                  "imageReference": {
                    "publisher": "Canonical",
                    "offer": "UbuntuServer",
                    "sku": "14.04.2-LTS"
                  },
                  "count": [ "steps('infrastructureConfig').numberOFWAFs" ]
                }
              ]
            },
            {
                "name": "f5WAFConfig",
                "label": "F5 WAF Config",
                "subLabel": {
                    "preValidation": "F5 WAF Configuration",
                    "postValidation": "Done"
                },
                "bladeTitle": "F5 WAF Configuration",
              "elements": [
                {
                  "name": "licenseToken1",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the first F5 WAF node.",
                  "constraints": {
                    "required": true,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken2",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the second F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken3",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the third F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken4",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the fourth F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken5",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the fifth F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken6",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the sixth F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken7",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the seventh F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                },
                {
                  "name": "licenseToken8",
                  "type": "Microsoft.Common.TextBox",
                  "label": "BYOL Token",
                  "toolTip": " BYOL Token for the eighth F5 WAF node.",
                  "constraints": {
                    "required": false,
                    "regex": "^([a-z0-9]+\\.)?([a-z0-9][a-z0-9-]*\\.)+[a-z]{2,6}$",
                    "validationMessage": "Must be a valid fully-qualified domain name."
                  }
                }
              ]
            },
            {
                "name": "appSettings",
                "label": "Application Settings",
                "subLabel": {
                    "preValidation": "Configure Application Settings.",
                    "postValidation": "Done"
                },
                "bladeTitle": "Application Settings",
                "elements": [
                  {
                    "name": "applicationName",
                    "type": "Microsoft.Common.TextBox",
                    "label": "Application Name",
                    "toolTip": "The name of the applicaiton that will be placed behind this WAF cluster to be protected.",
                    "constraints": {
                      "required": true
                    }
                  }
                ]
            },
            {
                "name": "securitySettings",
                "label": "Security Settings",
                "subLabel": {
                  "preValidation": "Configure the SharePoint servers",
                    "postValidation": "Done"
                },
                "bladeTitle": "SharePoint Server settings",
                "elements": [
                    {
                      "name": "spWebPublicIP",
                      "type": "Microsoft.Network.PublicIpAddressCombo",
                      "label": {
                        "publicIpAddress": "Public IP address for SharePoint web tier",
                        "domainNameLabel": "Domain name label for SharePoint web tier"
                      },
                      "toolTip": {
                        "domainNameLabel": "DNS label for the SharePoint web tiers' public IP address, which hosts the first site collection."
                      },
                      "defaultValue": {
                        "publicIpAddressName": "ip01"
                      },
                      "options": {
                        "hideNone": true,
                        "hideDomainNameLabel": false
                      },
                      "constraints": {
                            "required": true
                       } 
                    },
                    {
                        "name": "spVmSize",
                        "type": "Microsoft.Compute.SizeSelector",
                        "label": "SharePoint virtual machine size",
                        "toolTip": "The size of the virtual machines for the SharePoint web and app tiers.",
                        "recommendedSizes": [
                            "Standard_DS3",
                            "Standard_DS4",
                            "Standard_DS14"
                        ],
                        "constraints": {
                            "required": true,
                            "allowedSizes": [
                                "Standard_D3",
                                "Standard_DS3",
                                "Standard_D4",
                                "Standard_DS4",
                                "Standard_D11",
                                "Standard_DS11",
                                "Standard_D12",
                                "Standard_DS12",
                                "Standard_D13",
                                "Standard_DS13",
                                "Standard_D14",
                                "Standard_DS14"
                            ]
                        },
                        "osPlatform": "Windows",
                        "imageReference": {
                            "publisher": "MicrosoftSharePoint",
                            "offer": "MicrosoftSharePointServer",
                            "sku": "2013"
                        },
                        "count": 4
                    },
                    {
                        "name": "spSetupUserAccountUsername",
                        "type": "Microsoft.Compute.UserNameTextBox",
                        "label": "Setup user account username",
                        "toolTip": "A domain account with this username will be created to run setup and SharePoint Products Configuration Wizard.",
                        "defaultValue": "spsetup",
                        "osPlatform": "Windows",
                        "constraints": {
                            "required": true
                        } 
                    },
                    {
                        "name": "spSetupUserAccountPassword",
                        "type": "Microsoft.Compute.CredentialsCombo",
                        "label": {
                            "password": "Setup user account password",
                            "confirmPassword": "Confirm password"
                        },
                        "osPlatform": "Windows",
                        "constraints": {
                            "required": true
                        } 
                    },
                    {
                        "name": "spServerFarmAccountUsername",
                        "type": "Microsoft.Compute.UserNameTextBox",
                        "label": "Server farm account username",
                        "toolTip": "A domain account with this username will be created to perform the following tasks: configure and manage server farm, act as the application pool identity for the SharePoint Central Administration Web site and run the Microsoft SharePoint Foundation Workflow Timer Service.",
                        "defaultValue": "sp_farm",
                        "osPlatform": "Windows",
                        "constraints": {
                            "required": true
                        } 
                    },
                    {
                        "name": "spServerFarmAccountPassword",
                        "type": "Microsoft.Compute.CredentialsCombo",
                        "label": {
                            "password": "Server farm account password",
                            "confirmPassword": "Confirm password"
                        },
                        "osPlatform": "Windows",
                        "constraints": {
                            "required": true
                        } 
                    },
                    {
                        "name": "spServerFarmPassphrase",
                        "type": "Microsoft.Compute.CredentialsCombo",
                        "label": {
                            "password": "Server farm passphrase",
                            "confirmPassword": "Confirm passphrase"
                        },
                        "toolTip": {
                            "password": "A secure password phrase that will be used to join other machines to this farm."
                        },
                        "osPlatform": "Windows",
                        "constraints": {
                            "required": true
                        } 
                    },
                    {
                        "name": "spSiteTemplateName",
                        "type": "Microsoft.Common.DropDown",
                        "label": "Content site template",
                        "defaultValue": "Team Site",
                        "constraints": {
                            "required" : true,
                            "allowedValues": [
                                {
                                    "label": "Team Site",
                                    "value": "STS#0"
                                },
                                {
                                    "label": "Blank Site",
                                    "value": "STS#1"
                                },
                                {
                                    "label": "Document Workspace",
                                    "value": "STS#2"
                                },
                                {
                                    "label": "Document Workspace",
                                    "value": "STS#2"
                                },
                                {
                                    "label": "Basic Meeting Workspace",
                                    "value": "MPS#0"
                                },
                                {
                                    "label": "Decision Meeting Workspace",
                                    "value": "MPS#2"
                                },
                                {
                                    "label": "Wiki Site",
                                    "value": "WIKI#0"
                                },
                                {
                                    "label": "Central Admin Site",
                                    "value": "CENTRALADMIN#0"
                                }
                            ]
                        }
                    }
                ]
            }
        ],
      "outputs": {
        "location": "[location()]",
        "numberOFWAFs": "[basics('dnsNameForPublicIP')]",
        "vmSize": "[steps('infrastructureConfig').storageAccounts.prefix]",
        "dnsNameForPublicIP": "[steps('infrastructureConfig').storageAccounts.type]",
        "adminUsername": "[steps('infrastructureConfig').adminUsername]",
        "adminPassword": "[steps('infrastructureConfig').adminPassword.password]",
        "licenseToken1": "[steps('infrastructureConfig').virtualNetworkName]",
        "licenseToken2": "[steps('adConfig').adVmSize]",
        "licenseToken3": "[steps('sqlConfig').sqlVmSize]",
        "licenseToken4": "[steps('sqlConfig').witnessVMSize]",
        "applicationName": "[steps('spConfig').spVmSize]",
        "applicationProtocols": "[steps('adConfig').domainName]",
        "applicationAddress": "[steps('spConfig').spWebPublicIP.domainNameLabel]",
        "applicationPorts": "[steps('spConfig').spWebPublicIP.resourceGroup]",
        "applicationType": "[steps('spConfig').spWebPublicIP.name]",
        "blockingLevel": "[steps('spConfig').spWebPublicIP.newOrExistingOrNone]",
        "applicationFQDN": "[steps('sqlConfig').sqlServerServiceAccountUsername]",
        "applicationCertificate": "[steps('sqlConfig').sqlServerServiceAccountPassword.password]",
        "applicationKey": "[steps('spConfig').spSetupUserAccountUsername]",
        "applicationChain": "[steps('spConfig').spSetupUserAccountPassword.password]"
      }
    }
}
